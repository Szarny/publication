# はじめに
本エントリでは，[平成31年度春期 情報処理安全確保支援士試験 午後Ⅰ 問1](https://www.jitec.ipa.go.jp/1_04hanni_sukiru/mondai_kaitou_2019h31_1/2019h31h_sc_pm1_qs.pdf)を題材に，Webセキュリティに関する基礎的なトピックを説明します．  
本エントリで触れるキーワードは以下の通りです．
```
- SOP(Same Origin Poilcy)
    - Originについて
    - SOPの原理について

- CORS(Cross Origin Resource Sharing)
    - CORSの原理およびシーケンスについて
        - プリフライトリクエストとメインリクエスト
        - CORSでやり取りされるHTTP通信について

- JSONP(JavaScript Object Notation with Padding)
    - JSONPの原理について
```

# 問題を読む編
## はじめに
まずは問題の概観を掴んでいきます．  
問題文の最初のブロックから，以下のことがわかります．
```
- M社は複数のサイトを運営している
    - WebサイトA/コーポレートサイト(https://site-a.m-sha.co.jp/)
    - WebサイトB/ブランドサイト(https://site-b.m-sha.co.jp/)
    - WebサイトC/ブランドサイト
    - ...

- ブランドサイトではCookieを利用したセッション管理を行っている
```

## 情報連携編
WebサイトAとWebサイトBを連携させる話が浮上します．  
  
具体的には，「WebサイトAが各ブランドサイトの売れ筋商品情報を取得する」及び「希望する会員に電子メールを配信するためにWebサイトAが各ブランドサイトの会員情報を取得する」という機能を持たせるために，WebサイトAが売れ筋商品情報を取得するための`API-X`と会員情報を取得するための`API-Y`をWebサイトBに実装するという流れになっています．   
  
`API-Y`を用いて会員情報を取得する際のシーケンスは図1に記述されています．

|シーケンス|内容|
|:-:|:-|
|Y-1|WebブラウザからWebサイトAの申込ページにアクセスする|
|Y-2|WebサイトAからWebサイトBの`API-Y`を呼び出す`スクリプトZ`が返される|
|Y-3|会員がWebブラウザ上で申込を行う|
|Y-4|`スクリプトZ`は`API-Y`に対して会員情報を取得するためのリクエストを送信する|
|Y-5|`API-Y`から会員情報が返される|
|Y-6|Webブラウザが会員情報を表示する|
|Y-7|申込情報と会員情報がWebブラウザからWebサイトAに送られる|

## 実装についての検討編
さて，`スクリプトZ`は`[ a ]`ポリシによって`[ b ]`, `[ c ]`, `[ d ]`のいずれかが異なるリソースへのアクセスができないようです．  
これは何を意味しているのでしょうか．前提条件をもとに考えてみます．  
  
`スクリプトZ`はWebサイトA，つまり，`https://site-a.m-sha.co.jp/`から配信されています．  
この`スクリプトZ`がWeb上の任意のリソースからデータを読み取れるとしたらどうなるでしょうか．例えば，`スクリプトZ`がWebサイトAとは全く関係のないショッピングサイト(`https://shopping.com/`)にアクセスした上でコンテンツの内容を読み取り，それをWebサイトAに送信可能である場合，もしそのショッピングサイトのコンテンツに機密情報が含まれているとセキュリティ上の問題が発生します．  
つまり，以下のような流れで全く関係のないWebサイト上の機密情報が窃取されるおそれがあります．

1. ユーザがWebサイトAにアクセスすると`スクリプトZ`がダウンロードされる
1. `スクリプトZ`はショッピングサイトにアクセスする
1. ショッピングサイトはユーザの機密情報を含んだコンテンツをレスポンスする
1. `スクリプトZ`はレスポンスの内容を解析し，機密情報をサーバにアップロードする

このような問題を引き起こさないためには，Webサーバから提供されるスクリプトが任意のWebサイトからデータを取得できないように，何らかの線引きをする必要があります．  
  
例えば，`https://site-a.m-sha.co.jp/`のスクリプトが`https://site-a.m-sha.co.jp/`のコンテンツにアクセスする分には問題がなさそうですが，`https://site-a.m-sha.co.jp/`のスクリプトが`https://shopping.com/`のコンテンツにアクセスする場合には問題がありそうです．  
  
では，そのような線引きにどのような情報が使えそうかを考えてみます．Webにおいては特定のコンテンツを読み込む際にURLを用いるため，URLを使うのが良さそうです．  
しかしながら，URLも以下のように(これが全てではないですが)複数の要素から構成されています．どの要素を使うのが良いでしょうか．

```
スキーム://ホスト名:ポート名/パス?キー=値
```